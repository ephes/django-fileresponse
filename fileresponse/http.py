# AUTOGENERATED! DO NOT EDIT! File to edit: nbs/01_http.ipynb (unless otherwise specified).

__all__ = ['AsyncFileResponse']

# Cell

import time
import aiofiles


class AsyncFileResponse:
    def __init__(self, path):
        self.path = path
        self.chunk_size = kwargs.get("chunk_size", 4096)

    async def stream(self, send):
        started_serving = time.perf_counter()
        await send(
            {
                "type": "http.response.start",
                "status": self.status_code,
                "headers": self.raw_headers,
            }
        )
        async with aiofiles.open(self.path, mode="rb") as file:  # type: ignore
            more_body = True
            while more_body:
                chunk = await file.read(self.chunk_size)
                more_body = len(chunk) == self.chunk_size
                await send(
                    {
                        "type": "http.response.body",
                        "body": chunk,
                        "more_body": more_body,
                    }
                )
        self.elapsed = time.perf_counter() - started_serving